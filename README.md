# Kubernetes from scratch

## Start up vagrant and connect to master node

    vagrant up
    vagrant ssh master
    sudo su

### Problems

#### VERR_ALREADY_EXISTS

rm -rf ~/VirtualBox\ VMs/<my already existing vms>


## 0-PackageInstallation.sh
Notes:
- run package installation on master
- run each command sequentially
- running the shell script as a whole won't work

## 1-CreateMaster.sh

Notes on `kubeadm init`
- creates a self-signed CA
- secures cluster comms (i.e. with API Server)
- authentication of users and kubelets

See: https://kubernetes.io/docs/reference/setup-tools/kubeadm/kubeadm-init/#external-ca-mode

- creates kube .config files (from /etc/kubernetes)
- generates static manifests at /etc/kubernetes/manifests (i.e. for Control Plane)
- creates Pod Networking (using Calico)

Notes: alternatives to Calico are Flannel and Weave Net

- calico.yaml: should already have:

            - name: CALICO_IPV4POOL_CIDR
              value: "192.168.0.0/16"

- after running `sudo kubeadm init --pod-network-cidr=192.168.0.0/16` make note of the `kubeadm join ...` output. E.g. `kubeadm join 10.0.2.15:6443 --token az9vbo.ymf85m7dlj49qu6m     --discovery-token-ca-cert-hash sha256:1b7dc152f29d1ce29110deeeb570eebf73600b615d000250d586e656a6f80c0a`

Also, if you need to reset the master node use `kubeadm reset`.

## 2-CreateNodes.sh

    vagrant ssh node1
    sudo su

Notes:

- at this step: `sudo kubeadm join 172.16.94.10:6443` you need to make sure you're using the token / cert hash generated by the master earlier. However, `kubeadm init` can get the IP wrong so check you're using the IP address defined for master in the Vagrantfile (https://github.com/kubernetes/kubernetes/issues/58876)
If this is hanging use `--v=5`

- also, if you're getting `Failed to connect to API Server "172.16.94.10:6443": Get https://172.16.94.10:6443/api/v1/namespaces/kube-public/configmaps/cluster-info?timeout=10s: x509: certificate is valid for 10.96.0.1, 10.0.2.15, not 172.16.94.10`

- `I0306 14:34:10.387597   26585 token.go:191] [discovery] Failed to connect to API Server "172.16.94.10:6443": token id "vw95wq" is invalid for this cluster or it has expired. Use "kubeadm token create" on the control-plane node to create a new valid token`
means you need to generate a new token on master. See the token create step.
